version: "3.9"
services:
  mem-backend:
    image: ghcr.io/memowikis/mem-backend:${BUILD_NUMBER:-error}
    ports:
      - "${BACKEND_PORT:-7000}:5069"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    volumes:
      - ${HOST_IMAGE_PATH:-error}:{ABSOLUTE_IMAGE_PATH:-error}
    networks:
      - environment-specific-network
    environment:
      - ASPNETCORE_ENVIRONMENT=${ASPNETCORE_ENVIRONMENT:-Stage}
      - Paths__LomExportPath=${LOM_EXPORT_PATH}
      - Paths__AbsoluteImagePath=${ABSOLUTE_IMAGE_PATH:-error}
      - General__SeqUrl=${SEQ_URL:-error}
      - General__CanonicalHost=${CANONICAL_HOST:-error}
      - General__ConnectionString=${CONNECTION_STRING:-error}
      - General__Environment=${ENVIRONMENT:-error}
      - General__MemuchoUserId=${MEMUCHO_USER_ID:-error}
      - General__SaltCookie=${SALT_COOKIE:-error}
      - General__UpdateUserSettingsKey=${UPDATE_USER_SETTINGS_KEY:-error}
      - Settings__WithNHibernateStatistics=${WITH_NHIBERNATE_STATISTICS:-error}
      - Settings__DisableAllJobs=${DISABLE_ALL_JOBS:-error}
      - LoginProvider__FacebookAppId=${FACEBOOK_APP_ID:-error}
      - LoginProvider__FacebookAppSecret=${FACEBOOK_APP_SECRET:-error}
      - Stripe__WebhookKeyStripe=${WEBHOOK_KEY_STRIPE:-error}
      - Stripe__StripeBaseUrl=${STRIPE_BASE_URL:-error}
      - Meilisearch__MeiliSearchUrl=${MEILISEARCH_URL:-error}
      - Meilisearch__MeiliSearchMasterKey=${MEILISEARCH_MASTER_KEY:-error}
      - Email__EmailFrom=${EMAIL_FROM:-error}
      - Email__EmailToMemucho=${EMAIL_TO_MEMUCHO:-error}
      
networks:
  environment-specific-network:
    name: mem-${MEM_ENVIRONMENT:-stage}
    # Was already set up with nginx: 
    external: true

# Run in bash like this:
# $ export BUILD_NUMBER=5408
# $ docker-compose -p mem-stage up -d
# will recreate a running container